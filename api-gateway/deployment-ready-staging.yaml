# Deployment-ready Unified API specification
# Generated: 2025-12-03T16:53:30.622Z
# Stage: staging
# Layer: aifl
# Hybrid Authorizer: arn:aws:lambda:eu-west-2:193757560043:function:truss-hybrid-authorizer-staging

openapi: 3.0.1
info:
  title: Truss Annotation Intelligent Function API
  version: 1.0.0-staging
  description: |-
    Unified API with hybrid authentication (API Key + Cognito JWT)
    Layer: aifl

    ## Services Included

    - **image-service**: Image service for managing image uploads, processing status, and processed image URLs
    - **automated-annotation**: Automated annotation service using LangChain for knowledge extraction and text annotation

    ## Authentication

    This API supports hybrid authentication:
    - **API Key**: Include `x-api-key` header with your API key
    - **Cognito JWT**: Include `Authorization: Bearer <token>` header with your JWT

    Both methods are validated by the same hybrid authorizer.
  x-deployment:
    stage: staging
    layer: aifl
    timestamp: '2025-12-03T16:53:30.620Z'
    hybridAuthorizerArn: arn:aws:lambda:eu-west-2:193757560043:function:truss-hybrid-authorizer-staging
    services:
      - image-service
      - automated-annotation
servers:
  - url: https://${ApiId}.execute-api.eu-west-2.amazonaws.com/staging
    description: Staging environment
paths:
  /automations/annotation/bags/classify/model:
    post:
      summary: Classify bag model using vector-based similarity search (image vector from image). Returns model, model_id, root_model, root_model_id, and confidence.
      description: Classify bag model using vector-based similarity search (image vector from image). Returns model, model_id, root_model, root_model_id, and confidence.
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-automated-annotation-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - automated-annotation
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''POST,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
  /automations/annotation/bags/classify/{property}:
    post:
      summary: Classify a bag property (type, material, colour, etc.) using the DSL orchestrator. For model/material, returns simplified response with only essential fields.
      description: Classify a bag property (type, material, colour, etc.) using the DSL orchestrator. For model/material, returns simplified response with only essential fields.
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-automated-annotation-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - automated-annotation
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''POST,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
  /automations/annotation/health:
    get:
      summary: Health check endpoint for the automated annotation service
      description: Health check endpoint for the automated annotation service
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-automated-annotation-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - automated-annotation
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''GET,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
  /images/health:
    get:
      summary: Health check endpoint for the image service
      description: Health check endpoint for the image service
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-image-service-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - image-service
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''GET,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
  /images/image/{uniqueId}:
    delete:
      summary: Delete an image and all its processed versions
      description: Delete an image and all its processed versions
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-image-service-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - image-service
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''DELETE,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
  /images/list:
    get:
      summary: List images with optional filtering
      description: List images with optional filtering
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-image-service-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - image-service
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''GET,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
  /images/process/{uniqueId}:
    post:
      summary: Manually trigger processing for an uploaded image
      description: Manually trigger processing for an uploaded image
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-image-service-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - image-service
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''POST,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
  /images/processed/{uniqueId}:
    get:
      summary: Get processed image URLs for a specific upload
      description: Get processed image URLs for a specific upload
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-image-service-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - image-service
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''GET,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
  /images/status/{processingId}:
    get:
      summary: Get processing status for an image
      description: Get processing status for an image
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-image-service-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - image-service
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''GET,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
  /images/upload-url:
    get:
      summary: Generate a presigned URL for uploading images (query params)
      description: Generate a presigned URL for uploading images (query params)
      security:
        - HybridAuth: []
      responses:
        '200':
          description: Success
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Internal server error
      x-amazon-apigateway-integration:
        uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-aifl-image-service-staging/invocations
        passthroughBehavior: when_no_match
        httpMethod: POST
        type: aws_proxy
      tags:
        - image-service
    options:
      summary: CORS support
      security: []
      responses:
        '200':
          description: CORS enabled
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string
      x-amazon-apigateway-integration:
        type: mock
        requestTemplates:
          application/json: '{"statusCode": 200}'
        responses:
          default:
            statusCode: '200'
            responseParameters:
              method.response.header.Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Api-Key,X-Amz-Date,X-Amz-Security-Token'''
              method.response.header.Access-Control-Allow-Methods: '''GET,OPTIONS'''
              method.response.header.Access-Control-Allow-Origin: '''*'''
components:
  securitySchemes:
    HybridAuth:
      type: apiKey
      in: header
      name: Authorization
      description: 'Hybrid authentication: Accepts both ''Bearer <JWT>'' for Cognito and x-api-key header for API key auth'
      x-amazon-apigateway-authtype: custom
      x-amazon-apigateway-authorizer:
        type: request
        authorizerUri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:193757560043:function:truss-hybrid-authorizer-staging/invocations
        authorizerResultTtlInSeconds: 0
  schemas: {}
  responses: {}
  parameters: {}
  examples: {}
security:
  - HybridAuth: []
tags:
  - name: image-service
    description: Image service for managing image uploads, processing status, and processed image URLs
  - name: automated-annotation
    description: Automated annotation service using LangChain for knowledge extraction and text annotation
